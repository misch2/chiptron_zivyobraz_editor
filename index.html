<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <title>Editor obrázků pro zivyobraz.eu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            height: 100vh;
            margin: 0;
            background: #222;
            color: #fff;
            padding: 2em;
        }

        .controls {
            display: flex;
            flex-direction: column;
            width: 300px;
            margin-right: 2em;
        }

        .controls label,
        .controls button {
            width: 100%;
            margin-top: 1em;
        }

        input[type="range"],
        input[type="number"],
        button,
        select {
            width: 100%;
        }

        canvas {
            border: 1px solid #555;
            background: black;
            margin-top: 1em;
            display: block;
        }

        .preview-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        button {
            background-color: #333;
            border: 1px solid #444;
            color: #fff;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        button:hover {
            background-color: #555;
        }

        .icon {
            margin-right: 8px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slider-label span {
            margin-left: 10px;
            min-width: 40px;
            text-align: right;
        }
    </style>
</head>

<body>
    <div class="controls">
        <h1>Editor obrázků pro <a hred="https://zivyobraz.eu/">ZivyObraz.eu</a></h1>

        <input type="file" accept="image/*" id="upload"><br>
        <button onclick="downloadImage()"><i class="fas fa-download icon"></i>Stáhnout upravený obrázek</button>

        <div id="resolution-controls">
            <label>Výstupní šířka: <input type="number" id="outputWidth" value="800" min="1"></label>
            <label>Výstupní výška: <input type="number" id="outputHeight" value="480" min="1"></label>
            <button onclick="resizeCanvas()"><i class="fas fa-cogs icon"></i>Upravit rozlišení</button>
        </div>

        <div id="sliders" style="display:none;">
            <div class="slider-label">
                <label for="brightness">Jas:</label>
                <span id="brightnessValue">1.0</span>
            </div>
            <input type="range" min="0" max="3" step="0.1" value="1" id="brightness">

            <div class="slider-label">
                <label for="contrast">Kontrast:</label>
                <span id="contrastValue">1.0</span>
            </div>
            <input type="range" min="0" max="5" step="0.1" value="1" id="contrast">

            <div class="slider-label">
                <label for="saturation">Saturace:</label>
                <span id="saturationValue">1.0</span>
            </div>
            <input type="range" min="0" max="5" step="0.1" value="1" id="saturation">

            <div class="slider-label">
                <label for="gamma">Gamma:</label>
                <span id="gammaValue">1.0</span>
            </div>
            <input type="range" min="0.1" max="3" step="0.1" value="1" id="gamma">

        </div>

        <div id="crop-controls">
            <label>
                <input type="checkbox" id="cropImage">
                Oříznout podle poměru výstupního rozlišení
            </label>
        </div>

        <div id="rotation-controls">
            <label>Úhel rotace (0–360°): <input type="number" id="rotationAngle" value="0" min="0" max="360" step="1"></label>
            <button onclick="applyRotation()"><i class="fas fa-sync-alt icon"></i>Aplikovat rotaci a oříznutí</button>
        </div>

        <div id="border-controls">
            <label>Barva okraje:</label>
            <select id="borderColor">
                <option value="black">Černá</option>
                <option value="white">Bílá</option>
            </select>
            <button onclick="applyBorder()"><i class="fas fa-border-all icon"></i>Přidat okraj</button>
        </div>
    </div>

    <div class="preview-container">
        <canvas id="canvas" width="800" height="480"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let originalImage = null;
        let originalFilename = "upraveny_obrazek";
        let outputWidth = 800;
        let outputHeight = 480;
        let rotationAngle = 0;
        let borderColor = 'black';

        document.getElementById('upload').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file || !file.type.startsWith("image/") || file.size > 10 * 1024 * 1024) {
                alert("Prosím nahrajte pouze obrázky do 10 MB.");
                return;
            }

            originalFilename = file.name.replace(/\.[^/.]+$/, "");

            const reader = new FileReader();
            reader.onload = function (event) {
                const img = new Image();
                img.onload = function () {
                    originalImage = img;
                    document.getElementById('sliders').style.display = 'block';
                    drawImageWithAdjustments();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        ['brightness', 'contrast', 'saturation', 'gamma'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                document.getElementById(id + "Value").innerText = document.getElementById(id).value;
                drawImageWithAdjustments();
            });
        });

        function resizeCanvas() {
            outputWidth = parseInt(document.getElementById('outputWidth').value);
            outputHeight = parseInt(document.getElementById('outputHeight').value);
            canvas.width = outputWidth;
            canvas.height = outputHeight;
            drawImageWithAdjustments();
        }

        function applyRotation() {
            rotationAngle = parseInt(document.getElementById('rotationAngle').value);
            drawImageWithAdjustments();
        }

        function applyBorder() {
            borderColor = document.getElementById('borderColor').value;
            drawImageWithAdjustments();
        }

        function applyGammaCorrection(imageData, gamma) {
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                for (let j = 0; j < 3; j++) { // For R, G, B channels
                    const value = data[i + j];
                    data[i + j] = 255 * Math.pow(value / 255, 1 / gamma);
                }
            }
        }

        function drawImageWithAdjustments() {
            if (!originalImage) return;

            const brightness = parseFloat(document.getElementById('brightness').value);
            const contrast = parseFloat(document.getElementById('contrast').value);
            const saturation = parseFloat(document.getElementById('saturation').value);
            const gamma = parseFloat(document.getElementById('gamma').value);
            const crop = document.getElementById('cropImage').checked;

            ctx.fillStyle = borderColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const img = originalImage;
            let sx = 0, sy = 0, sWidth = img.width, sHeight = img.height;
            let dx = 0, dy = 0, dWidth = outputWidth, dHeight = outputHeight;

            if (crop) {
                const imgAspect = img.width / img.height;
                const canvasAspect = outputWidth / outputHeight;

                if (imgAspect > canvasAspect) {
                    sWidth = img.height * canvasAspect;
                    sx = (img.width - sWidth) / 2;
                } else {
                    sHeight = img.width / canvasAspect;
                    sy = (img.height - sHeight) / 2;
                }
            } else {
                const ratio = Math.min(outputWidth / img.width, outputHeight / img.height);
                dWidth = img.width * ratio;
                dHeight = img.height * ratio;
                dx = (outputWidth - dWidth) / 2;
                dy = (outputHeight - dHeight) / 2;
            }

            ctx.save();
            ctx.filter = `
        brightness(${brightness})
        contrast(${contrast})
        saturate(${saturation})
      `;
            ctx.translate(outputWidth / 2, outputHeight / 2);
            ctx.rotate(rotationAngle * Math.PI / 180);
            ctx.translate(-outputWidth / 2, -outputHeight / 2);
            ctx.drawImage(img, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);

            // Apply gamma correction
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            applyGammaCorrection(imageData, gamma);
            ctx.putImageData(imageData, 0, 0);

            ctx.restore();
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = `${originalFilename}_upraveno.png`;
            link.href = canvas.toDataURL();
            link.click();
        }
    </script>
</body>

</html>